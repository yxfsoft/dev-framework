# 任务 YAML 格式规范
# 所有任务文件必须符合此 schema
# 注意：此文件仅作参考文档，框架运行时不执行 YAML Schema 校验。

---

# 必须字段
required_fields:
  - id           # 唯一标识，格式: CR-xxx 或 INF-xxx 或 F-xxx 或 HF-xxx
  - type         # 任务类型
  - iteration    # 所属迭代 ID
  - title        # 任务标题（简短描述）
  - priority     # 优先级
  - design       # 技术方案（hotfix 类型豁免）
  - affected_files  # 受影响文件列表
  - acceptance_criteria  # 验收标准列表（hotfix 类型豁免）
  - status       # 当前状态

# hotfix 类型豁免字段
# hotfix 为紧急修复快速通道，以下字段非必须:
#   - design（hotfix 用 fix_description 替代）
#   - acceptance_criteria（hotfix 用 verification 替代）

# 字段定义
fields:

  id:
    type: string
    pattern: "^(CR|INF|F|HF)-\\d{3,}$"
    description: "任务唯一标识"

  type:
    type: string
    enum:
      - new_feature     # 新功能
      - bug_fix         # Bug 修复
      - enhancement     # 功能增强
      - refactor        # 重构
      - infrastructure  # 基础设施（使用 feature.yaml.tmpl 作为基础模板，type 字段填 "infrastructure"）
      - hotfix          # 紧急修复
    description: "任务类型"

  iteration:
    type: string
    pattern: "^iter-\\d+$"
    description: "所属迭代 ID，统一使用 iter-N 格式（如 iter-0、iter-3）"

  priority:
    type: string
    enum:
      - P0    # 阻断（必须最先处理）
      - P1    # 必须（本轮迭代必须完成）
      - P2    # 可选（资源允许时完成）
    default: "P1"
    description: "任务优先级"

  title:
    type: string
    max_length: 100
    description: "任务标题"

  description:
    type: string
    description: "任务详细描述（功能说明、修复描述等）"

  design:
    type: object
    required: [approach, why_this_approach]
    properties:
      approach:
        type: string
        description: "技术方案描述"
      why_this_approach:
        type: string
        description: "选择此方案的原因（必须说明 why）"
      edge_cases:
        type: array
        description: "边界条件列表（结构化）"
        items:
          type: object
          required: [scenario, input, expected]
          properties:
            scenario:
              type: string
              description: "场景名称"
            input:
              type: string
              description: "触发条件/输入"
            expected:
              type: string
              description: "期望行为"
            verify_method:
              type: string
              description: "验证方式（可选）"
      config_params:
        type: array
        items: string
        description: "需要的配置参数"

  affected_files:
    type: array
    items: string
    max_items: 5
    description: "受影响的文件路径（不超过 5 个）"

  affected_modules:
    type: array
    items: string
    description: "受影响的模块名列表（enhancement 等类型使用）"
    applicable_types: [enhancement]

  acceptance_criteria:
    type: object
    description: "验收标准，按维度分组。functional 至少 1 条，其余分组可为空（标注 N/A）"
    required: [functional]
    properties:
      functional:
        type: array
        min_items: 1
        description: "功能验收（至少 1 条）"
        items: &ac_item
          type: object
          required: [id, desc, status]
          properties:
            id:
              type: string
              description: "验收标准 ID"
            desc:
              type: string
              description: "验收标准描述"
            status:
              type: string
              enum: [FAIL, PASS]
              description: "验收状态（初始为 FAIL）"
      robustness:
        type: array
        description: "健壮性验收"
        items: *ac_item
      performance:
        type: array
        description: "性能验收"
        items: *ac_item
      ux_states:
        type: array
        description: "UX 状态覆盖验收"
        items: *ac_item
      ux_interaction:
        type: array
        description: "UX 交互验收"
        items: *ac_item
      security:
        type: array
        description: "安全验收"
        items: *ac_item
      observability:
        type: array
        description: "可观测性验收"
        items: *ac_item

  status:
    type: string
    enum:
      - pending            # 待认领
      - in_progress        # 开发中
      - ready_for_verify   # 等待验收（verifier 子代理执行 L0 验收 + 证据收集）
      - ready_for_review   # 等待审查（reviewer 子代理代码审查 + 裁决）
      - PASS               # 审查通过（终态，大写以区分）
      - rework             # 被打回
      - failed             # 超过重试上限
      - blocked            # 外部阻塞
      - timeout            # 执行超时
    description: |
      任务状态。命名约定：
      - 过程态使用小写下划线（pending, in_progress, ready_for_verify 等）
      - 终态成功使用大写（PASS）以视觉突出
      - review_result.verdict 使用大写（PASS / REWORK）
      代码中比较状态值时必须使用精确匹配，不可忽略大小写。

  current_step:
    type: string
    nullable: true
    enum:
      - reading_code       # 正在读代码
      - coding             # 正在编码
      - self_check         # 编码自检
      - testing            # 运行 L1 测试
      - regression         # 基线回归
      - committing         # git commit
      - ready_for_verify   # 已提交验收
    description: |
      当前执行步骤（in_progress 时由 developer 子代理更新）。
      每个 Step 开始时必须先更新此字段，再执行操作。
      用于上下文压缩后恢复执行进度。详见 developer 子代理协议 §二。

  # 可选字段
  owner:
    type: string
    description: "认领者标识"

  retries:
    type: integer
    default: 0
    description: "重试次数（每次 rework 时自增，由 verifier/reviewer 子代理标记 rework 时更新）"

  max_retries:
    type: integer
    nullable: true
    default: null
    description: |
      单任务最大重试次数。null 时使用 run-config.yaml 的 max_retries_per_task（默认 2）。
      超过此值时 Leader 将任务标记为 failed。
      恢复 failed 任务必须由 Leader 执行并记录 decisions.md。

  depends:
    type: array
    items: string
    description: "依赖的其他任务 ID"

  commits:
    type: array
    items: string
    description: "关联的 git commit hash"

  notes:
    type: string
    description: "备注（developer 子代理填写已读文件等信息）"

  done_evidence:
    type: object
    # nullable: 任务创建初期可为 null，模板建议预填空结构 { tests: [], logs: [], notes: [] }
    nullable: true
    description: "验收证据归档（verifier 子代理填写，developer 子代理不可修改）"
    properties:
      tests:
        type: array
        items: string
        description: "测试执行结果摘要"
      logs:
        type: array
        items: string
        description: "关键日志或命令输出摘要"
      notes:
        type: array
        items: string
        description: "补充说明"

  decisions_ref:
    type: array
    description: "关联的决策编号列表，详细内容见 decisions.md"
    items: {type: string}

  review_result:
    type: object
    nullable: true
    properties:
      reviewer:
        type: string
        description: "审查者标识"
      reviewed_at:
        type: string
        format: datetime
        description: "审查时间"
      verdict:
        type: string
        enum: [PASS, REWORK]
        description: "审查结论（PASS / REWORK）"
      notes:
        type: string
        description: "审查备注"
      issues:
        type: array
        items:
          type: object
          properties:
            severity:
              type: string
              enum: [critical, high, medium, low]
            desc:
              type: string
            suggestion:
              type: string
          required: [severity, desc]
        description: "审查发现的问题列表"

  # hotfix 类型专用字段
  fix_description:
    type: string
    description: "修复方案描述（hotfix 专用，替代 design 字段）"
    applicable_types: [hotfix]

  verification:
    type: string
    description: "验证方式描述（hotfix 专用，替代 acceptance_criteria 字段）"
    applicable_types: [hotfix]

  # bug_fix 类型专用字段
  current_behavior:
    type: string
    applicable_types: [bug_fix, enhancement]

  expected_behavior:
    type: string
    applicable_types: [bug_fix]

  desired_behavior:
    type: string
    applicable_types: [enhancement]

  reproduction_steps:
    type: string
    applicable_types: [bug_fix]

  root_cause:
    type: string
    applicable_types: [bug_fix]

  regression_test:
    type: string
    applicable_types: [bug_fix, enhancement, new_feature, refactor]

  new_test:
    type: string
    applicable_types: [bug_fix]

  # refactor 类型专用字段
  motivation:
    type: string
    applicable_types: [refactor]

  invariants:
    type: array
    items: string
    applicable_types: [refactor]

  # new_feature 类型专用字段（iterate-mode）
  integration_points:
    type: array
    applicable_types: [new_feature]

  data_flow:
    type: string
    applicable_types: [new_feature]

  ux_considerations:
    type: string
    applicable_types: [enhancement, new_feature]
