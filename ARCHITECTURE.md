# Dev-Framework 架构决策记录

> 记录框架核心设计决策的"为什么"，每条 ADR 包含决策、原因、替代方案、后果。

---

## ADR-001: 5 角色制衡模型

**决策**：采用 Leader + Analyst + Developer + Verifier + Reviewer 五角色模型，各角色权限严格分离。

**原因**：
- 单一 Agent 全能模式缺乏制衡，容易出现"自编自审"导致质量失控
- 角色分离使得每个 Agent 可以专注于核心职责，避免职责膨胀
- Developer 不能自评通过（P4 原则），Verifier 提供客观验收，Reviewer 做最终裁决

**替代方案**：三角色模型（合并 Verifier 到 Developer）。在 CR ≤ 3 的小型任务中采用此简化模式（Leader 兼任 Developer 和 Verifier）。

**后果**：团队规模略大，但质量保障链更完整：编码→独立验收→独立审查。

---

## ADR-002: 默认禁止 Mock（P2 原则）

**决策**：测试默认禁止 Mock，仅白名单场景（付费外部 API、CI 无硬件、不可控第三方）允许使用。

**原因**：
- Mock 泛滥导致测试与真实环境脱节，"测试全绿但上线出 bug"
- 本地文件系统、SQLite、自有 HTTP API 等完全可以用真实轻量替代（tmp_path、:memory:、TestClient）
- 强制使用白名单 + 声明理由，确保每个 Mock 都有合理依据

**替代方案**：允许自由 Mock + 人工审查。实践证明人工审查 Mock 合规性成本高且容易遗漏。

**后果**：测试编写成本略高，但测试可信度显著提升。

---

## ADR-003: 磁盘状态为唯一真相源（P3 原则）

**决策**：所有关键信息在产生时立即写入磁盘，对话上下文仅作短期工作记忆。

**原因**：
- Claude Code 的上下文窗口有限，自动压缩会丢失细节
- 会话中断（网络、CLI 崩溃）随时可能发生
- 磁盘状态文件使得任何新 session 都能完整恢复上下文

**替代方案**：依赖对话上下文 + 定期保存。不可靠，因为上下文压缩时机不可控。

**后果**：写入磁盘的频率较高，但换来了完整的中断恢复能力和人员切换能力。

---

## ADR-004: Agent 不可自评通过（P4 原则）

**决策**：Developer 只能标记 `ready_for_verify`，Verifier 只能标记 `ready_for_review`，只有 Reviewer 可以标记 `PASS`。

**原因**：
- 自评通过缺乏客观性，Developer 可能对自己的代码盲区视而不见
- 三阶段制衡（编码→验收→审查）确保质量层层递进
- Verifier 独立运行 verify 脚本并收集证据，提供客观的验收基础

**替代方案**：Developer 自行运行 verify 后直接提交 Reviewer。缺少独立验收环节，Developer 可能忽略 verify 的部分失败。

**后果**：流程多一个环节（Verifier），但验收的客观性和证据链完整性更有保障。

---

## ADR-005: 垂直切片 + 基础设施分层（P5 原则）

**决策**：init-mode 采用"基础设施先冻结 + 垂直切片并行"策略。

**原因**：
- 基础设施（DB schema、配置框架、API 骨架）是所有切片的共享依赖，必须先稳定
- 垂直切片（端到端数据流）确保每个切片独立可验证
- 冻结基础设施后切片可以安全并行，减少冲突

**替代方案**：水平分层开发（先做完数据层，再做服务层，再做 API 层）。这种方式在全部完成前无法进行端到端验证。

**后果**：基础设施阶段需要更多前期设计，但后续切片开发更独立、更高效。

---

## ADR-006: 8 层质量门控

**决策**：从 Gate 0（环境就绪）到 Gate 7（最终验收），设置 8 个质量门控点（Gate 0-7）。

**原因**：
- 问题越早发现修复成本越低
- 每个 Phase 结束时设置门控，确保前置条件满足后再进入下一阶段
- Gate 3（L0 验收）、Gate 4（L1 回归）、Gate 5（集成检查点）形成多层测试网

**替代方案**：简化为 3 层（编码完成检查 + 测试通过检查 + 最终审查）。覆盖不够细致，容易在早期阶段积累质量债务。

**后果**：流程检查点较多，但每个门控的检查内容明确且可自动化。

---

## ADR-007: Auto Loop 多重安全阀

**决策**：Auto Loop 模式设置多重安全阀（连续失败停止、基线退化停止、单任务超时、git 冲突停止）。

**原因**：
- 无人值守模式下，错误可能滚雪球式放大
- 基线退化是最严重的信号，必须立即停止
- 连续失败说明可能遇到系统性问题，继续执行只会浪费资源
- 超时保护防止单个任务阻塞整个流水线

**替代方案**：简单的重试机制（失败就重试 N 次）。无法检测系统性问题，可能在错误方向上浪费大量时间。

**后果**：Auto Loop 模式更安全可控，适合大批量任务的夜间运行。

---

## ADR-008: 七路径拆分法

**决策**：任务拆分前必须沿七条路径（Happy/Sad/Edge/Perf/UX/Guard/Ops）逐条审视功能，每条路径要么产出 CR，要么标注不适用。

**原因**：
- 按技术层拆分（后端/前端/测试）容易遗漏非功能维度（性能/安全/可观测性），导致产品"能用但粗糙"
- 按路径拆分强制审视每个质量维度，确保产出深度而非仅广度
- UX Path 采用"定位→推导"方法论而非固定模式清单，适应不同产品类型

**替代方案**：固定 UX 模式清单（骨架屏/防抖/响应式等）。不同产品类型的 UX 最佳实践差异太大，固定清单会误导而非引导。

**后果**：拆分步骤增加一个审视环节（七路径表格 + UX 四步推导），但产出的 CR 在非功能维度的覆盖面显著提升。
