# Dev-Framework 架构决策记录

> 版本: v3.0 | 更新日期: 2026-02-21

> 记录框架核心设计决策的"为什么"，每条 ADR 包含决策、原因、替代方案、后果。

---

## ADR-001: 5 角色制衡模型

**决策**：采用 Leader + Analyst + Developer + Verifier + Reviewer 五角色模型，各角色权限严格分离。

**原因**：
- 单一 Agent 全能模式缺乏制衡，容易出现"自编自审"导致质量失控
- 角色分离使得每个 Agent 可以专注于核心职责，避免职责膨胀
- Developer 不能自评通过（P4 原则），Verifier 提供客观验收，Reviewer 做最终裁决

**替代方案**：三角色模型（合并 Verifier 到 Developer）。经 grzsk 项目实战验证，任何形式的角色合并都会削弱质量保障链，即使 CR 数量少也不允许简化。v2.6 起废除此替代方案。

**后果**：团队规模略大，但质量保障链更完整：编码→独立验收→独立审查。

---

## ADR-002: 默认禁止 Mock（P2 原则）

**决策**：测试默认禁止 Mock，仅白名单场景（付费外部 API、CI 无硬件、不可控第三方）允许使用。

**原因**：
- Mock 泛滥导致测试与真实环境脱节，"测试全绿但上线出 bug"
- 本地文件系统、SQLite、自有 HTTP API 等完全可以用真实轻量替代（tmp_path、:memory:、TestClient）
- 强制使用白名单 + 声明理由，确保每个 Mock 都有合理依据

**替代方案**：允许自由 Mock + 人工审查。实践证明人工审查 Mock 合规性成本高且容易遗漏。

**后果**：测试编写成本略高，但测试可信度显著提升。

---

## ADR-003: 磁盘状态为唯一真相源（P3 原则）

**决策**：所有关键信息在产生时立即写入磁盘，对话上下文仅作短期工作记忆。

**原因**：
- Claude Code 的上下文窗口有限，自动压缩会丢失细节
- 会话中断（网络、CLI 崩溃）随时可能发生
- 磁盘状态文件使得任何新 session 都能完整恢复上下文

**替代方案**：依赖对话上下文 + 定期保存。不可靠，因为上下文压缩时机不可控。

**后果**：写入磁盘的频率较高，但换来了完整的中断恢复能力和人员切换能力。

---

## ADR-004: Agent 不可自评通过（P4 原则）

**决策**：Developer 只能标记 `ready_for_verify`，Verifier 只能标记 `ready_for_review`，只有 Reviewer 可以标记 `PASS`。

**原因**：
- 自评通过缺乏客观性，Developer 可能对自己的代码盲区视而不见
- 三阶段制衡（编码→验收→审查）确保质量层层递进
- Verifier 独立运行 verify 脚本并收集证据，提供客观的验收基础

**替代方案**：Developer 自行运行 verify 后直接提交 Reviewer。缺少独立验收环节，Developer 可能忽略 verify 的部分失败。

**后果**：流程多一个环节（Verifier），但验收的客观性和证据链完整性更有保障。

---

## ADR-005: 垂直切片 + 基础设施分层（P5 原则）

**决策**：init-mode 采用"基础设施先冻结 + 垂直切片并行"策略。

**原因**：
- 基础设施（DB schema、配置框架、API 骨架）是所有切片的共享依赖，必须先稳定
- 垂直切片（端到端数据流）确保每个切片独立可验证
- 冻结基础设施后切片可以安全并行，减少冲突

**替代方案**：水平分层开发（先做完数据层，再做服务层，再做 API 层）。这种方式在全部完成前无法进行端到端验证。

**后果**：基础设施阶段需要更多前期设计，但后续切片开发更独立、更高效。

---

## ADR-006: 10 层质量门控

**决策**：设置 10 个质量门控点（Gate 0-7 + Gate 2.5 + Gate 3.5），覆盖从环境就绪到最终验收的全流程。

**原因**：
- 问题越早发现修复成本越低
- 每个 Phase 结束时设置门控，确保前置条件满足后再进入下一阶段
- Gate 3（L0 验收）、Gate 4（L1 回归）、Gate 5（集成检查点）形成多层测试网

**替代方案**：简化为 3 层（编码完成检查 + 测试通过检查 + 最终审查）。覆盖不够细致，容易在早期阶段积累质量债务。

**后果**：流程检查点较多，但每个门控的检查内容明确且可自动化。

---

## ADR-007: Auto Loop 多重安全阀

**决策**：Auto Loop 模式设置多重安全阀（连续失败停止、基线退化停止、单任务超时、git 冲突停止）。

**原因**：
- 无人值守模式下，错误可能滚雪球式放大
- 基线退化是最严重的信号，必须立即停止
- 连续失败说明可能遇到系统性问题，继续执行只会浪费资源
- 超时保护防止单个任务阻塞整个流水线

**替代方案**：简单的重试机制（失败就重试 N 次）。无法检测系统性问题，可能在错误方向上浪费大量时间。

**后果**：Auto Loop 模式更安全可控，适合大批量任务的夜间运行。

---

## ADR-008: 七路径拆分法

**决策**：任务拆分前必须沿七条路径（Happy/Sad/Edge/Perf/UX/Guard/Ops）逐条审视功能，每条路径要么产出 CR，要么标注不适用。

**原因**：
- 按技术层拆分（后端/前端/测试）容易遗漏非功能维度（性能/安全/可观测性），导致产品"能用但粗糙"
- 按路径拆分强制审视每个质量维度，确保产出深度而非仅广度
- UX Path 采用"定位→推导"方法论而非固定模式清单，适应不同产品类型

**替代方案**：固定 UX 模式清单（骨架屏/防抖/响应式等）。不同产品类型的 UX 最佳实践差异太大，固定清单会误导而非引导。

**后果**：拆分步骤增加一个审视环节（七路径表格 + UX 四步推导），但产出的 CR 在非功能维度的覆盖面显著提升。

---

## ADR-009: 合并 Agent 协议到 CLAUDE.md（v3.0）

**决策**：将所有 5 个 Agent 协议 + 质量门控规则合并写入 `.claude/CLAUDE.md`，使其成为自包含的框架运行时手册。

**原因**：
- `.claude/CLAUDE.md` 位于系统提示层，在上下文压缩过程中**永远不会被丢弃**
- 通过 Read 工具读取的 `agents/*.md` 文件内容位于对话历史层，**会被压缩丢失**
- 两种方式消耗的 Token 相同（~1,900 行），但持久性完全不同
- 压缩后 Agent 丢失所有协议内容，导致不遵守五角色工作流（Developer 自评通过、跳过 Verifier/Reviewer）

**替代方案**：
1. 强化引导加载指令（在 CLAUDE.md 中写"每次都要重新读取 agents/*.md"）。被拒：无法保证执行，压缩后指令本身也可能被简化
2. 启动脚本注入（用脚本在 Claude 启动前将 agent 内容注入系统提示）。被拒：绕过了原生 CLAUDE.md 机制，维护复杂

**后果**：`.claude/CLAUDE.md` 增至 ~1,900 行（含项目配置约 ~2,000 行），占 200K 上下文的 ~18%。独立 `agents/` 目录后续在 ADR-011 中正式删除。

---

## ADR-010: 滚动上下文快照（v3.0）

**决策**：新增 `context-snapshot.md` 滚动快照文件，每个显著动作后用 Write 工具整体覆盖更新。

**原因**：
- 合并 CLAUDE.md 解决了"协议丢失"问题，但无法解决"工作状态丢失"问题
- 压缩后 Agent 知道流程（因为协议在系统提示中），但不知道"进行到哪里了"
- `context-snapshot.md` 提供一个轻量级入口，Agent 读取后可快速恢复进度、关键决策和技术上下文
- 文件每次整体覆盖（不是追加），大小恒定，不会无限增长

**替代方案**：依赖 session-manager.py resume。被拒：resume 输出冗长，需要运行外部脚本，不如直接读文件高效

**后果**：每个显著动作后多一次 Write 操作，但换来了快速、可靠的跨会话状态恢复。

---

## ADR-011: 删除独立 agents/ 和 workflows/ 目录（v3.0）

**决策**：删除框架根目录下的 `agents/` 和 `workflows/` 目录（共 9 个文件），所有内容统一到 `templates/project/CLAUDE-framework.md.tmpl`。

**原因**：
- v3.0 运行时 Agent 协议从 `.claude/CLAUDE.md`（由 CLAUDE-framework.md.tmpl 生成）加载，独立文件不再是运行时依赖
- ADR-009 将 Agent 协议合并到 CLAUDE.md 后，`agents/*.md` 仅作为参考副本存在，与 CLAUDE-framework.md.tmpl 内容几乎完全重复
- `workflows/*.md` 的核心内容（init-mode/iterate-mode 规则、需求接收、质量门控）已在 CLAUDE-framework.md.tmpl 的 Leader/Analyst 协议和 §七 中完整覆盖
- 维护两套内容导致版本不一致和更新遗漏的风险

**替代方案**：保留为参考副本。被拒：维护成本高，且实际从未被运行时读取，新用户可能误以为需要手动加载这些文件

**后果**：
- 框架目录结构简化（减少 2 个目录、9 个文件）
- `init-project.py` 不再复制 agent 文件到项目
- CLAUDE-framework.md.tmpl 成为所有 Agent 协议和工作流规则的唯一权威来源
- FRAMEWORK-SPEC.md、README.md、USER-GUIDE.md 同步更新引用

---

## ADR-013: 轻量迭代模式 (lightweight) 定义（v3.0.1）

**决策**：定义轻量迭代模式的完整执行规则，包括启用条件、Phase 合并方式、合并 Agent 职责和记录义务。

**原因**：
- v3.0 中 lightweight 模式仅标记为"实验性"，缺少完整的执行规则和启用条件
- 部分迭代（CR≤5 或全为 enhancement/bug_fix）不需要完整的五角色流程，过重的流程反而降低效率
- 需要在效率和质量之间找到合理的平衡点

**适用条件**（必须同时满足）：
- CR 数量 ≤ 5，或全部为 enhancement/bug_fix 类型
- 无 P0 阻断级别的任务
- 在 decisions.md 中声明并记录原因

**Phase 合并方式**：
- Phase 3.5（验收）和 Phase 4（审查）合并为一个"Verify+Review"阶段
- 由同一 Agent 同时执行 Verifier 和 Reviewer 的职责
- Phase 门控（phase-gate.py）的检查不变，仍然强制执行

**质量权衡**：
- 维度 D（回归安全）降级为抽检关键路径（非全量检查）
- 维度 E（证据完整性）仅检查必要证据项是否存在，不做深度审查
- 其他维度（A/B/C）的检查标准不变

**替代方案**：始终使用完整五角色流程。被拒：小规模迭代的时间开销不成比例。

**后果**：小规模迭代效率提升，但需要接受 D/E 维度检查深度降低的风险。

---

## ADR-012: upgrade-project.py 重构计划（v3.1）

**决策**：将 `upgrade-project.py` 的重构列为 v3.1 计划项。

**原因**：
- 当前 upgrade-project.py 硬编码了 v2.6→v3.0 的迁移逻辑，随着版本演进会越来越难维护
- 需要引入版本化迁移机制（类似数据库 migration），每个版本升级对应一个迁移函数
- v3.0.1 阶段优先修复已确认的 15 个问题，重构工作延后

**替代方案**：在 v3.0.1 中直接重构。被拒：当前升级脚本功能正常，重构优先级低于质量修复。

**后果**：v3.1 版本需投入时间重构升级机制，但 v3.0.1 可更快发布。
