# 需求接收与深化工作流

> 适用于：所有模式（init-mode / iterate-mode）
> 执行者：Analyst Agent + Leader Agent
> 目的：将用户粗略需求转化为专业级需求规格书

---

## 一、触发条件

当用户提交新需求时（无论复杂度），本工作流自动触发。

---

## 二、Step 1: 需求读取

Analyst 读取用户提供的需求输入：
- 文字描述
- 文档链接/路径
- Issue/Bug 报告
- 截图/录屏

同时读取项目上下文：
- CLAUDE.md（项目规范）
- ARCHITECTURE.md（架构约束）
- 已有的 feature-checklist.json（init-mode）
- 最近的 iteration 报告（iterate-mode）

---

## 三、Step 2: 成熟度评估

Analyst 按以下标准评估需求成熟度：

### 高成熟度（可直接拆分）
- 明确描述了期望行为（"搜索响应时间从 3s 降到 1s 以内"）
- 包含边界条件（"空查询返回最近记录，超长查询截断"）
- 有量化指标或明确完成标准

### 中成熟度（需补充 1-2 个维度）
- 描述了期望行为但缺少边界条件
- 有方向但指标不够量化（"搜索要快"）

### 低成熟度（需全面梳理）
- 仅描述大方向（"优化搜索"、"改进体验"）
- 缺少具体期望行为描述
- 无量化标准

---

## 四、Step 3: 交互确认（必须，不可跳过）

向用户展示评估结果：

```
【需求评估】

您的需求: "{用户原始描述}"

功能概述: {Analyst 理解的需求摘要}
成熟度评估: {高/中/低}
{如果中/低} 建议补充的方面:
  - {维度 1}: {缺什么}
  - {维度 2}: {缺什么}
{如果高} 可直接拆分的原因: {说明}

请选择:
  A) 需求已明确，直接进入任务拆分
  B) 需要协助梳理完善需求，完善后再拆分
  C) 我补充一些信息: ___
```

---

## 五、Step 4: 按路径执行

### 路径 A: 直接拆分

需求成熟度高，但 Analyst 仍需应用八维度专业标准补全：

1. 读取需求中已明确的内容
2. 按八维度检查是否有遗漏
3. 补全遗漏的维度（基于专业判断，不询问用户）
4. 输出完整的 requirement-spec.md
5. 展示给用户做最终确认

### 路径 B: 协助完善

逐维度与用户交互，每个维度给出专业建议：

#### 维度 1: 功能行为
```
当前理解: {Analyst 理解的功能}

需要明确的点:
1. 正常流程: {描述} — 是否准确？
2. 异常场景:
   a) {场景 1} → 建议处理方式: {方案}
   b) {场景 2} → 建议处理方式: {方案}
3. 边界条件:
   a) {条件 1} → 建议: {处理方式}
   b) {条件 2} → 建议: {处理方式}

请确认/调整上述内容。
```

#### 维度 2: 用户体验
```
操作流程分析:
1. 用户触发: {如何触发}
2. 交互过程: {步骤}
3. 结果反馈: {如何知道成功/失败}

建议优化:
- {优化点 1}
- {优化点 2}

请确认/调整。
```

#### 维度 3: 数据影响
```
数据模型影响分析:
- 现有表/Collection: {是否需要变更}
- 新增数据: {是否需要新表/字段}
- 数据迁移: {是否需要}
- 兼容性: {旧数据如何处理}

请确认。
```

#### 维度 4: 性能要求
```
性能指标建议:
- 响应时间: {建议值} (当前: {实测值})
- 数据量级: {预估}
- 并发: {预估}
- 内存/CPU: {约束}

请确认或调整。
```

#### 维度 5: 安全影响
```
安全评估:
- 认证/授权: {是否受影响}
- 数据暴露: {是否有新风险}
- 输入校验: {是否需要新增}

如果都不涉及，本维度跳过。
```

#### 维度 6: 集成影响
```
集成点分析:
- API 兼容: {是否破坏现有 API}
- 配置兼容: {是否需要新配置项}
- 下游依赖: {哪些模块受影响}

请确认。
```

**每个维度确认后进入下一个。全部完成后输出 requirement-spec.md。**

### 路径 C: 用户补充

1. 接收用户补充信息
2. 重新评估成熟度
3. 回到 Step 3

---

## 六、Step 5: 输出需求规格书

```markdown
# 需求规格书: {标题}

## 1. 概述
- 来源: {用户原始描述}
- 类型: {bug_fix / enhancement / new_feature / refactor}
- 优先级: {critical / high / medium / low}
- 确认方式: {路径 A/B/C}

## 2. 现状分析（iterate-mode）
- 当前实现: {代码引用 file:line}
- 当前行为: {描述}
- 当前问题: {具体问题}

## 3. 目标状态
- 期望行为: {描述}
- 量化指标: {可测量的标准}

## 4. 功能规格
### 4.1 正常流程
  {步骤}
### 4.2 异常流程
  | 异常场景 | 处理方式 |
  |---------|---------|
### 4.3 边界条件
  | 条件 | 处理方式 |
  |------|---------|

## 5. 用户体验规格
- 操作流程: {步骤}
- 反馈机制: {加载/成功/失败}
- 错误提示: {具体文案}

## 6. 数据影响
- 模型变更: {是/否，详情}
- 迁移方案: {是/否，详情}
- 兼容策略: {描述}

## 7. 性能指标
| 指标 | 目标值 | 当前值 |
|------|-------|-------|

## 8. 安全要求
- {列出安全约束}

## 9. 集成影响
- API 变更: {描述}
- 配置变更: {描述}
- 下游影响: {描述}

## 10. 验收标准
| # | 标准 | 可验证方式 |
|---|------|-----------|
| 1 | {描述} | {如何验证} |
| 2 | {描述} | {如何验证} |
```

写入 `iteration-{id}/requirement-spec.md`。

---

## 七、Step 6: 用户最终确认

Interactive 模式下展示需求规格书，等待用户：
- 确认 → 进入 Phase 2 任务拆分
- 修改 → Analyst 调整后重新展示
- 否决 → 重新进入 Step 2

Auto-loop 模式下自动通过。

---

## 八、质量标准

需求规格书必须满足：
- [ ] 所有 10 个章节都有内容（不适用的标注"不适用"并说明原因）
- [ ] 验收标准至少 3 条，每条可机器验证
- [ ] 性能指标有量化值
- [ ] 异常场景至少列出 3 个
- [ ] 边界条件至少列出 2 个
